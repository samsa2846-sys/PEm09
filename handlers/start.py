"""
Start and Help Command Handlers.
Handles /start and /help commands using pyTelegramBotAPI.
"""

from telebot import types
from bot import bot
from utils.logging import logger
from utils.helpers import user_sessions
from config import BotMode, DEFAULT_MODE


@bot.message_handler(commands=['start'])
async def cmd_start(message: types.Message):
    """Handle /start command."""
    user_id = message.from_user.id
    user_name = message.from_user.first_name
    
    logger.info(f"User {user_id} started the bot")
    
    # Initialize user session
    user_sessions.set_mode(user_id, DEFAULT_MODE)
    
    welcome_text = f"""üëã –î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user_name}!

–Ø - **—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç-—ç–∫—Å–ø–µ—Ä—Ç** –ø–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏ "–õ–ò–¢–õ–ò–î–ï–†" (–ª—é–∫–∏ –∏ –¥–æ–∂–¥–µ–ø—Ä–∏–µ–º–Ω–∏–∫–∏).

**–ß—Ç–æ —è —É–º–µ—é:**

üîç **–ü–æ–¥–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ü–∏–∏** - –ø–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å –ª—é–∫ –∏–ª–∏ –¥–æ–∂–¥–µ–ø—Ä–∏–µ–º–Ω–∏–∫ –¥–ª—è –≤–∞—à–∏—Ö –∑–∞–¥–∞—á
üìã **–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏** - –æ–±—ä—è—Å–Ω—é –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —Ç–∏–ø–∞ –¢–ú(–î400)-2-7-9-60
‚öôÔ∏è **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏** - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –≤–µ—Å, —Ä–∞–∑–º–µ—Ä—ã, –∫–ª–∞—Å—Å –Ω–∞–≥—Ä—É–∑–∫–∏
üìä **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π** - –æ–±—ä—è—Å–Ω—é —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ (–ø–ª–∞–≤–∞—é—â–∏–µ/–æ–±—ã—á–Ω—ã–µ, –∫–ª–∞—Å—Å—ã –Ω–∞–≥—Ä—É–∑–∫–∏)
üíº **–ü–æ–º–æ—â—å –≤ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –ö–ü** - –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**

/help - –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
/mode rag - **–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º**
/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
/reset - –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥

**–ö–∞–∫ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É:**

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /mode rag –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ–∂–∏–º–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
2. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏
3. –ü–æ–ª—É—á–∞–π—Ç–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞

–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ø–æ–¥–±–æ—Ä–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è! üèóÔ∏è"""
    
    await bot.send_message(message.chat.id, welcome_text)


@bot.message_handler(commands=['help'])
async def cmd_help(message: types.Message):
    """Handle /help command."""
    user_id = message.from_user.id
    logger.info(f"User {user_id} requested help")
    
    help_text = """üìñ **–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–±–æ—Ç–µ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º**

**üéØ –û–°–ù–û–í–ù–û–ô –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´: RAG (–ö–∞—Ç–∞–ª–æ–≥)**

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –∫–∞—Ç–∞–ª–æ–≥–æ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```
/mode rag
```

**üìö –¢–∏–ø–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —è –æ—Ç–≤–µ—á—É:**

**–ü–æ–¥–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ü–∏–∏:**
‚Ä¢ "–ö–∞–∫–æ–π –ª—é–∫ –≤—ã–±—Ä–∞—Ç—å –¥–ª—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–≥–∏?"
‚Ä¢ "–ü–æ—Å–æ–≤–µ—Ç—É–π –¥–æ–∂–¥–µ–ø—Ä–∏–µ–º–Ω–∏–∫ –¥–ª—è –ø–µ—à–µ—Ö–æ–¥–Ω–æ–π –∑–æ–Ω—ã"
‚Ä¢ "–ù—É–∂–µ–Ω –ª—é–∫ –∫–ª–∞—Å—Å–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ D400, —á—Ç–æ –µ—Å—Ç—å?"

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏:**
‚Ä¢ "–†–∞—Å—à–∏—Ñ—Ä—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É –¢–ú(–î400)-2-7-9-60"
‚Ä¢ "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–ª–∞—Å—Å –Ω–∞–≥—Ä—É–∑–∫–∏ B125?"
‚Ä¢ "–û–±—ä—è—Å–Ω–∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ –° (B125)-2-60"

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
‚Ä¢ "–°–∫–æ–ª—å–∫–æ –≤–µ—Å–∏—Ç –ª—é–∫ —Ç–∏–ø–∞ –¢–ú(–î400)?"
‚Ä¢ "–ö–∞–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã —É –¥–æ–∂–¥–µ–ø—Ä–∏–µ–º–Ω–∏–∫–∞ –î–ë1-40?"
‚Ä¢ "–ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é –ª—é–∫–∞?"

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ –≤—ã–±–æ—Ä:**
‚Ä¢ "–í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ø–ª–∞–≤–∞—é—â–∏–º –∏ –æ–±—ã—á–Ω—ã–º –ª—é–∫–æ–º?"
‚Ä¢ "–ö–∞–∫–∏–µ –∫–ª–∞—Å—Å—ã –Ω–∞–≥—Ä—É–∑–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç?"
‚Ä¢ "–î–ª—è —á–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–ª–∞—Å—Å E600?"

**‚öôÔ∏è –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

/mode rag - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º (–æ—Å–Ω–æ–≤–Ω–æ–π)
/mode text - –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º GPT-4o
/mode voice - –≥–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º (—Å TTS –æ—Ç–≤–µ—Ç–∞–º–∏)
/mode vision - –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä—Ç–µ–∂–µ–π/—Ñ–æ—Ç–æ

/reset - –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
/stats - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ

**üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–∞:**

–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ:
‚Ä¢ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª—é–∫–æ–≤ –∏ –¥–æ–∂–¥–µ–ø—Ä–∏–µ–º–Ω–∏–∫–æ–≤
‚Ä¢ –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–µ –∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è—Ö
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
‚Ä¢ –í–µ—Å–µ –∏ —Ä–∞–∑–º–µ—Ä–∞—Ö
‚Ä¢ –û–±–ª–∞—Å—Ç—è—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
‚Ä¢ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ –∏–∑–¥–µ–ª–∏–π

**üí° –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:**

1. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π—Ç–µ —Ä–µ–∂–∏–º /mode rag –ø–µ—Ä–µ–¥ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø—Ä–æ–¥—É–∫—Ü–∏–∏
2. –ú–æ–∂–µ—Ç–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞—Ä—Ç–∏–∫—É–ª—ã –∏–ª–∏ –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
3. –Ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
4. –î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä—Ç–µ–∂–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /mode vision

**üîß –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
‚Ä¢ GPT-4o –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
‚Ä¢ ChromaDB –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
‚Ä¢ LangChain –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF-–∫–∞—Ç–∞–ª–æ–≥–∞

–ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã! üèóÔ∏è"""
    
    await bot.send_message(message.chat.id, help_text)


@bot.message_handler(commands=['reset'])
async def cmd_reset(message: types.Message):
    """Handle /reset command - clear conversation history."""
    user_id = message.from_user.id
    
    user_sessions.clear_history(user_id)
    logger.info(f"User {user_id} cleared conversation history")
    
    await bot.send_message(
        message.chat.id,
        "‚úÖ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞!\n\n"
        "–ù–∞—á–Ω–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
    )


@bot.message_handler(commands=['stats'])
async def cmd_stats(message: types.Message):
    """Handle /stats command - show knowledge base statistics."""
    user_id = message.from_user.id
    logger.info(f"User {user_id} requested stats")
    
    try:
        from rag.query import get_knowledge_base_stats
        
        stats = get_knowledge_base_stats()
        
        if "error" in stats:
            await bot.send_message(
                message.chat.id,
                f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:\n{stats['error']}"
            )
            return
        
        total_docs = stats.get("total_documents", 0)
        total_chunks = stats.get("total_chunks", 0)
        persist_dir = stats.get("persist_directory", "N/A")
        
        # –£–ø—Ä–æ—â–∞–µ–º –ø—É—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è –ø–∞–ø–∫–∏)
        if persist_dir != "N/A":
            persist_dir_display = persist_dir.split("\\")[-1] if "\\" in persist_dir else persist_dir.split("/")[-1]
        else:
            persist_dir_display = "N/A"
        
        if total_chunks > 0:
            status_msg = "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
        else:
            status_msg = "–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"
        
        stats_text = (
            "=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===\n\n"
            f"–î–æ–∫—É–º–µ–Ω—Ç–æ–≤: {total_docs}\n"
            f"–§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: {total_chunks}\n"
            f"–ò–Ω–¥–µ–∫—Å: {persist_dir_display}\n\n"
            f"–°—Ç–∞—Ç—É—Å: {status_msg}\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /mode rag –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
        await bot.send_message(message.chat.id, stats_text, parse_mode="")
        
    except Exception as e:
        logger.error(f"Error getting stats: {e}")
        await bot.send_message(
            message.chat.id,
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π."
        )
