# Этап 4. Архитектура проекта

## Схема пайплайна обработки запросов

```
Пользователь (Telegram)
    ↓
handlers/ [text/voice/image/rag]
    ↓
services/router.py (маршрутизация)
    ↓
┌─────────────────────────────────────────┐
│  Yandex Cloud API Services              │
│  - YandexGPT (текст, RAG)               │
│  - SpeechKit (STT/TTS)                  │
│  - Vision (OCR, классификация)          │
└─────────────────────────────────────────┘
    ↓
rag/index_simple.py (keyword search)
    ↓
data/simple_index/ (база знаний)
    ↓
Ответ пользователю в Telegram
```

## Описание структуры проекта

### Папки и их назначение

**handlers/** — Обработчики команд и сообщений Telegram бота. Каждый файл отвечает за свой тип запроса: `text.py` обрабатывает текстовые сообщения, `voice.py` — голосовые, `image.py` — изображения, `rag.py` — запросы к базе знаний. Здесь происходит первичная обработка входящих сообщений от пользователя.

**services/** — Сервисный слой для работы с внешними API. `yandex_client.py` содержит клиенты для YandexGPT, SpeechKit и Vision API. `router.py` маршрутизирует запросы к нужным сервисам в зависимости от режима бота. Здесь централизована вся логика взаимодействия с AI-сервисами.

**rag/** — Модуль работы с базой знаний (Retrieval-Augmented Generation). `index_simple.py` индексирует документы и выполняет поиск по ключевым словам, `query.py` формирует контекст и генерирует ответы на основе найденных фрагментов. Использует keyword-based поиск вместо векторных эмбеддингов.

**data/** — Хранилище данных проекта. `documents/` содержит исходные документы для RAG (PDF, TXT), `simple_index/` — сохраненный индекс документов. Также здесь временно сохраняются голосовые файлы и изображения.

**utils/** — Вспомогательные утилиты. Логирование, конвертация аудио форматов, работа с пользовательскими сессиями и история диалогов.

### Как работает маршрутизация запросов

1. **Получение запроса**: Пользователь отправляет сообщение в Telegram. Handler определяет тип сообщения (текст/голос/изображение) и текущий режим бота.

2. **Маршрутизация**: `services/router.py` получает запрос и направляет его в нужный сервис в зависимости от режима (`text`, `voice`, `rag`, `vision`). Для текстовых запросов проверяется намерение сгенерировать изображение.

3. **Обработка**: Соответствующий клиент (`yandex_gpt_client`, `yandex_speechkit_client`, `yandex_vision_client`) отправляет запрос в Yandex Cloud API. В режиме RAG дополнительно происходит поиск релевантных фрагментов в базе знаний через keyword search.

4. **Возврат ответа**: Результат обработки возвращается через router обратно в handler, который форматирует и отправляет ответ пользователю в Telegram.

## Ключевые особенности архитектуры

- **Модульность**: Четкое разделение на слои (handlers, services, RAG) упрощает поддержку и расширение
- **Провайдер API**: Используется Yandex Cloud вместо OpenAI для соответствия региональным требованиям
- **Простой RAG**: Keyword-based search вместо векторных эмбеддингов (ChromaDB не требуется)
- **Асинхронность**: Все операции выполняются асинхронно через `async/await` для быстрой обработки

## Технологический стек

- **Backend**: Python 3.14, pyTelegramBotAPI (async)
- **AI Services**: Yandex Cloud (YandexGPT, SpeechKit, Vision)
- **RAG**: Keyword-based search (regex, custom indexing)
- **Database**: JSON файлы для хранения индекса
- **Logging**: Встроенный logging module Python

